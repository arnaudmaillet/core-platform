# .bazelrc

# ==================================================================
# CONFIGURATION GÉNÉRALE
# ==================================================================
build --announce_rc
build --color=yes
build --compilation_mode=opt
common --ui_event_filters=-INFO,-DEBUG
build --show_progress_rate_limit=30
build --workspace_status_command=tools/workspace_status.sh

# ==================================================================
# CACHE & PERFORMANCE
# ==================================================================
# Le cache sera monté via un volume Docker pour persister
build --disk_cache=/root/.cache/bazel-disk-cache

# ==================================================================
# TOOLCHAINS & PLATEFORMES (Linux Hermétique)
# ==================================================================
# On utilise la résolution stricte car on est sur Linux
build --incompatible_enable_cc_toolchain_resolution
build --extra_toolchains=@llvm_toolchain//:all

# Permet de construire des images OCI sans démon Docker
build --define=oci_go_binary=true

# ==================================================================
# CONFIGURATION RUST & LIBS
# ==================================================================

# Affiche les logs en cas d'échec des tests (crucial pour Testcontainers)
test:ci --test_output=errors
# Augmente le timeout car l'initialisation des containers peut être lente en CI
test:ci --test_timeout=300,600,1200,3600

# Réduit la consommation de ressources pour éviter que l'agent OOM (Out Of Memory)
build:ci --local_resources=cpu=HOST_CPUS-1
build:ci --local_resources=memory=HOST_RAM-1024

# Optimisation du cache sur GitHub Actions
# Permet de ne pas invalider le cache inutilement à cause du timestamp des fichiers
build:ci --collect_code_coverage=false

# build:ci --remote_cache=https://ghcr.io/votre-org/votre-repo # Optionnel: si vous avez un cache distant
build:ci --jobs=4

build --workspace_status_command=tools/workspace_status.sh

# Permet de construire des images OCI sans avoir besoin d'un démon Docker local
# (Très important pour la rapidité sur GitHub Actions)
build --define=oci_go_binary=true
build:ci --extra_toolchains=@llvm_toolchain//:all

# ==================================================================
# CONFIGURATION CI & RESSOURCES (GitHub Actions)
# ==================================================================
# On garde le flag :ci pour les réglages spécifiques à l'agent GitHub
build:ci --local_resources=cpu=HOST_CPUS-1,memory=HOST_RAM-1024
build:ci --jobs=4

test:ci --test_output=errors
test:ci --test_timeout=300,600,1200,3600

# Permet de construire des images OCI sans avoir besoin d'un démon Docker local
# (Très important pour la rapidité sur GitHub Actions)
build --define=oci_go_binary=true
build:ci --extra_toolchains=@llvm_toolchain//:all

# ==================================================================
# CONFIGURATION CI & RESSOURCES (GitHub Actions)
# ==================================================================
# On garde le flag :ci pour les réglages spécifiques à l'agent GitHub
build:ci --local_resources=cpu=HOST_CPUS-1,memory=HOST_RAM-1024
build:ci --jobs=4

test:ci --test_output=errors
test:ci --test_timeout=300,600,1200,3600

# Permet de construire des images OCI sans avoir besoin d'un démon Docker local
# (Très important pour la rapidité sur GitHub Actions)
build --define=oci_go_binary=true
build:ci --extra_toolchains=@llvm_toolchain//:all

# ==================================================================
# CONFIGURATION CI & RESSOURCES (GitHub Actions)
# ==================================================================
# On garde le flag :ci pour les réglages spécifiques à l'agent GitHub
build:ci --local_resources=cpu=HOST_CPUS-1,memory=HOST_RAM-1024
build:ci --jobs=4

test:ci --test_output=errors
test:ci --test_timeout=300,600,1200,3600

# Permet de construire des images OCI sans avoir besoin d'un démon Docker local
# (Très important pour la rapidité sur GitHub Actions)
build --define=oci_go_binary=true
build:ci --extra_toolchains=@llvm_toolchain//:all

# ==================================================================
# CONFIGURATION CI & RESSOURCES (GitHub Actions)
# ==================================================================
# On garde le flag :ci pour les réglages spécifiques à l'agent GitHub
build:ci --local_resources=cpu=HOST_CPUS-1,memory=HOST_RAM-1024
build:ci --jobs=4

test:ci --test_output=errors
test:ci --test_timeout=300,600,1200,3600

# Pour builder pour x86_64 même depuis un Mac ARM via Docker
build:linux_x86 --platforms=//tools/platforms:linux_x86_64