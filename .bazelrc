# ==================================================================
# CONFIGURATION GÉNÉRALE
# ==================================================================

# Affiche les options actives au démarrage pour faciliter le débug
build --announce_rc
build --color=yes

# Optimisation du build (Release mode par défaut)
build --copt=-O3
build --compilation_mode=opt

# Logs propres : évite de polluer la console avec des milliers de lignes INFO
common --ui_event_filters=-INFO,-DEBUG
build --show_progress_rate_limit=30

# ==================================================================
# CACHE & PERFORMANCE
# ==================================================================

# Cache local : Bazel réutilisera les objets déjà compilés
# Sur GitHub Actions, ce dossier pourra être mis en cache entre les runs
build --disk_cache=~/.cache/bazel-disk-cache

# ==================================================================
# TOOLCHAINS & PLATEFORMES
# ==================================================================

# On laisse Bazel détecter automatiquement l'OS hôte (Linux sur CI, macOS en local)
# La toolchain LLVM définie dans MODULE.bazel s'occupera de l'herméticité.

# On force l'utilisation des toolchains enregistrées pour Rust et LLVM
build --incompatible_enable_cc_toolchain_resolution

# ==================================================================
# CONFIGURATION SPÉCIFIQUE POUR LA CI (GitHub Actions)
# ==================================================================

# Affiche les logs en cas d'échec des tests (crucial pour Testcontainers)
test:ci --test_output=errors
# Augmente le timeout car l'initialisation des containers peut être lente en CI
test:ci --test_timeout=300,600,1200,3600

# Réduit la consommation de ressources pour éviter que l'agent OOM (Out Of Memory)
build:ci --local_cpu_resources=HOST_CPUS-1
build:ci --local_ram_resources=HOST_RAM-1024

# Optimisation du cache sur GitHub Actions
# Permet de ne pas invalider le cache inutilement à cause du timestamp des fichiers
build:ci --collect_code_coverage=false

# ==================================================================
# CONFIGURATION RUST
# ==================================================================

# On s'assure que Bazel propage les variables d'environnement nécessaires
build --action_env=PATH
build --action_env=LD_LIBRARY_PATH

# ==================================================================
# OPTIONS DE DÉPLOIEMENT (OCI / DOCKER)
# ==================================================================

# Permet de construire des images OCI sans avoir besoin d'un démon Docker local
# (Très important pour la rapidité sur GitHub Actions)
build --define=oci_go_binary=true
build --workspace_status_command=tools/workspace_status.sh
build:ci --extra_toolchains=@llvm_toolchain//:all
build:ci --incompatible_enable_cc_toolchain_resolution